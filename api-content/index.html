{"posts":[{"title":"ElasticSearchä¸­compositeèšåˆçš„ä½¿ç”¨ã€è½¬ã€‘","content":"ç®€ä»‹composite compositeæ˜¯ä¸€ä¸ªå¤šæ¡¶èšåˆï¼Œå®ƒä»ä¸åŒçš„æºåˆ›å»ºå¤åˆæ¡¶ï¼Œä¸å…¶ä»–å¤šæ¡¶èšåˆä¸åŒï¼Œå¤åˆèšåˆå¯ç”¨äºé«˜æ•ˆåœ°å¯¹å¤šçº§èšåˆä¸­çš„æ‰€æœ‰æ¡¶è¿›è¡Œåˆ†é¡µã€‚è¿™ç§èšåˆæä¾›äº†ä¸€ç§æ–¹æ³•æ¥æµç‰¹å®šèšåˆçš„æ‰€æœ‰æ¡¶ï¼Œç±»ä¼¼äºæ»šåŠ¨å¯¹æ–‡æ¡£æ‰€åšçš„æ“ä½œã€‚ ç»„åˆæ¡¶æ˜¯ç”±ä¸ºæ¯ä¸ªæ–‡æ¡£æå–/åˆ›å»ºçš„å€¼çš„ç»„åˆæ„å»ºçš„ï¼Œæ¯ä¸ªç»„åˆè¢«è§†ä¸ºç»„åˆæ¡¶ã€‚å¦‚ä¸‹ä¸ºå®˜æ–¹ç»™çš„ä¾‹å­ï¼š { &quot;keyword&quot;: [&quot;foo&quot;, &quot;bar&quot;], &quot;number&quot;: [23, 65, 76] } å¦‚æœæˆ‘ä»¬åŒæ—¶å¯¹keywordå’Œnumberä¸¤ä¸ªå­—æ®µè¿›è¡Œèšåˆä¼šå¾—å‡ºä»¥ä¸‹çš„ç»“æœ: { &quot;keyword&quot;: &quot;foo&quot;, &quot;number&quot;: 23 } { &quot;keyword&quot;: &quot;foo&quot;, &quot;number&quot;: 65 } { &quot;keyword&quot;: &quot;foo&quot;, &quot;number&quot;: 76 } { &quot;keyword&quot;: &quot;bar&quot;, &quot;number&quot;: 23 } { &quot;keyword&quot;: &quot;bar&quot;, &quot;number&quot;: 65 } { &quot;keyword&quot;: &quot;bar&quot;, &quot;number&quot;: 76 } çœ‹åˆ°ä¸Šé¢çš„ä¾‹å­æ˜¯ä¸æ˜¯æç„¶å¤§æ‚Ÿï¼Œ å°±åƒç±»ä¼¼sqlä¸­çš„å¤šgroup by å¤šå­—æ®µï¼Œå¯ä»¥å¯¹å¤šä¸ªå­—æ®µè¿›è¡Œèšåˆï¼Œè¿™éå¸¸é€‚ç”¨äºå¯¹äºå¤šç»´åº¦å‡ºæŠ¥è¡¨çš„éœ€æ±‚ï¼Œæˆ‘è¿™é‡Œå»ºè®®ä½¿ç”¨çš„ç‰ˆæœ¬ä¸º6.5+ï¼Œå› ä¸º6.5ç‰ˆæœ¬ä»¥ä¸‹æ­¤åŠŸèƒ½è¿˜å¤„äºæµ‹è¯•é˜¶æ®µï¼Œè®¾è®¡å’Œä»£ç æ²¡æœ‰æ­£å¼çš„GAåŠŸèƒ½æˆç†Ÿï¼Œå¹¶ä¸”æ²¡æœ‰æ‹…ä¿ã€‚å½“ç„¶æˆ‘è¿™é‡Œä¹Ÿä¼šæä¾›6.5ç‰ˆæœ¬ä»¥ä¸‹å¦‚ä½•è¿›è¡Œå¤šèšåˆå­—æ®µçš„ä½¿ç”¨ã€‚ é¦–å…ˆä¸Šå®˜æ–¹æ–‡æ¡£åœ°å€: https://www.elastic.co/guide/en/elasticsearch/reference/6.5/search-aggregations-bucket-composite-aggregation.html å…¶å®å®˜æ–¹æ–‡æ¡£å·²ç»æŠŠè¯¥åŠŸèƒ½è¯´å¾—å¾ˆè¯¦ç»†ï¼Œå¦‚æœä½ åªæ˜¯å•çº¯å†™DSLå®ç°çš„è¯çœ‹å®˜æ–¹æ–‡æ¡£å°±å¯ä»¥ï¼Œæˆ‘æ¥ä¸‹æ¥å°±ä»‹ç»å¦‚ä½•è°ƒç”¨ä»–çš„javaAPIæ¥ä½¿ç”¨ï¼Œå½“ç„¶å¦‚æœé˜…è¯»æºç èƒ½åŠ›å¼ºçš„è¯ä¹Ÿå¯ä»¥ç›´æ¥çœ‹å®˜æ–¹åœ¨githubçš„test,åœ°å€å¦‚ä¸‹: https://github.com/elastic/elasticsearch/tree/master/server/src/test/java/org/elasticsearch/search/aggregations/bucket/composite éªŒè¯å¤šå­—æ®µèšåˆå¯è¡Œæ€§ ä¸Šé¢çš„ä¾‹å­ä¸ºå®˜æ–¹ä¾‹å­ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±å¼„ä¸ªä¾‹å­æ£€æŸ¥å¯è¡Œæ€§ï¼Œæˆ‘ä»¬ç°åœ¨åˆ›å»ºä¸€ä¸ªindex,ç´¢å¼•åä¸ºcomposite_test,mappingå¦‚ä¸‹ { &quot;area&quot; : { &quot;type&quot; : &quot;keyword&quot; }, &quot;userid&quot; : { &quot;type&quot; : &quot;keyword&quot; }, &quot;sendtime&quot; : { &quot;type&quot; : &quot;date&quot;, &quot;format&quot; : &quot;yyyy-MM-dd HH:mm:ss&quot; } } æˆ‘ä»¬åˆ›å»ºå¥½äº†indexï¼Œindexä¸­ä¸€å…±æœ‰ä¸‰ä¸ªå­—æ®µï¼Œareaï¼Œuseridï¼Œsendtimeä¸‰ä¸ªå­—æ®µï¼Œæˆ‘ä»¬ä¹Ÿä½¿ç”¨MySQLæ•°æ®å»ºä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„è¡¨ï¼Œæ–¹ä¾¿å¯¹æ¯”èšåˆå‡ºæ¥çš„æ•°æ®æ˜¯å¦æ­£ç¡®ï¼Œè¡¨åä¸ºcomposite_testã€‚ æˆ‘ä»¬é¦–å…ˆå¯¹æ•°æ®è¡¨composite_testæ’å…¥5æ¡è®°å½•ï¼Œåˆ†åˆ«å¦‚ä¸‹ ä½¿ç”¨group byå¯¹ä¸‰ä¸ªå­—æ®µè¿›è¡Œèšåˆï¼Œä»¥ä¸‹ä¸ºåœ¨æ•°æ®åº“ä¸­çš„å®ç°ï¼š SELECT COUNT(1),area,userid,sendtime FROM composite_test GROUP BY area,userid,sendtime ç»“æœå¦‚ä¸‹: ä»¥ä¸Šä¸ºæ•°æ®åº“çš„èšåˆå®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ESè¿›è¡Œå¤šå­—æ®µèšåˆçš„æ—¶å€™å¦‚æœç»“æœå’Œä»¥ä¸Šçš„ä¸€æ ·åˆ™æ˜¯æ­£ç¡®çš„ï¼Œæˆ‘ä»¬ä¹Ÿä¸€æ ·å¾€ES composite_testç´¢å¼•ä¸­ æ’å…¥ç›¸åŒçš„5æ¡æ•°æ®,åœ¨kibanaä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ’å…¥ã€‚ POST composite_test/_bulk { &quot;index&quot; : {&quot;_type&quot; :&quot;_doc&quot;}} {&quot;area&quot;:&quot;33&quot;,&quot;userid&quot;:&quot;400015&quot;,&quot;sendtime&quot;:&quot;2019-01-17 00:00:00&quot;} { &quot;index&quot; : {&quot;_type&quot; : &quot;_doc&quot;}} {&quot;area&quot;:&quot;33&quot;,&quot;userid&quot;:&quot;400015&quot;,&quot;sendtime&quot;:&quot;2019-01-17 00:00:00&quot;} { &quot;index&quot; : {&quot;_type&quot; : &quot;_doc&quot;}} {&quot;area&quot;:&quot;35&quot;,&quot;userid&quot;:&quot;400016&quot;,&quot;sendtime&quot;:&quot;2019-01-18 00:00:00&quot;} { &quot;index&quot; : { &quot;_type&quot; : &quot;_doc&quot;}} {&quot;area&quot;:&quot;35&quot;,&quot;userid&quot;:&quot;400016&quot;,&quot;sendtime&quot;:&quot;2019-01-18 00:00:00&quot;} { &quot;index&quot; : {&quot;_type&quot; : &quot;_doc&quot;}} {&quot;area&quot;:&quot;33&quot;,&quot;userid&quot;:&quot;400017&quot;,&quot;sendtime&quot;:&quot;2019-01-17 00:00:00&quot;} æŸ¥è¯¢ESï¼Œæˆ‘ä»¬å‘ç°å·²ç»å­˜åœ¨äº†è¿™5æ¡æ•°æ®äº†ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬å…ˆä½¿ç”¨compositeçš„DSLæŸ¥è¯¢ï¼š GET composite_test/_search { &quot;size&quot;: 0, &quot;aggs&quot; : { &quot;my_buckets&quot;: { &quot;composite&quot; : { &quot;sources&quot; : [ { &quot;area&quot;: { &quot;terms&quot;: {&quot;field&quot;: &quot;area&quot; } } }, { &quot;userid&quot;: { &quot;terms&quot;: {&quot;field&quot;: &quot;userid&quot; } } }, { &quot;sendtime&quot;: { &quot;date_histogram&quot;: { &quot;field&quot;: &quot;sendtime&quot;,&quot;interval&quot;: &quot;1d&quot;,&quot;format&quot;: &quot;yyyy-MM-dd&quot;} } } ] } } } } DSLä¸­å‚æ•°çš„æ„æ€è¯·è‡ªè¡Œå‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œéƒ½è¯´å¾—å¾ˆè¯¦ç»†çš„,ä»¥ä¸Šè¿™å¥ç†è®ºä¸Šæ˜¯ç­‰å€¼äºæ•°æ®åº“çš„é‚£å¥èšåˆè¯­å¥çš„ï¼ŒæŸ¥è¯¢ç»“æœå¦‚ä¸‹ [ { &quot;key&quot; : { &quot;area&quot; : &quot;33&quot;, &quot;userid&quot; : &quot;400015&quot;, &quot;sendtime&quot; : &quot;2019-01-17&quot; }, &quot;doc_count&quot; : 2 }, { &quot;key&quot; : { &quot;area&quot; : &quot;33&quot;, &quot;userid&quot; : &quot;400017&quot;, &quot;sendtime&quot; : &quot;2019-01-17&quot; }, &quot;doc_count&quot; : 1 }, { &quot;key&quot; : { &quot;area&quot; : &quot;35&quot;, &quot;userid&quot; : &quot;400016&quot;, &quot;sendtime&quot; : &quot;2019-01-18&quot; }, &quot;doc_count&quot; : 2 } ] ä»ä»¥ä¸Šå“åº”çš„jsonæ•°ç»„ä¸­æˆ‘ä»¬ä¸éš¾çœ‹å‡ºï¼Œè¯¥èšåˆèšåˆå‡ºæ¥çš„æ•°æ®æ˜¯å’Œæ•°æ®åº“èšåˆå‡ºæ¥çš„æ•°æ®æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥ compositeæ˜¯å¯ä»¥ä½¿ç”¨åœ¨å¤šå­—æ®µèšåˆä¸Šçš„ã€‚è®ºè¯å®Œå¯è¡Œæ€§ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä½¿ç”¨javaæ¥å®ç°ï¼Œå®è¯è¯´è¿™ä¸€å—æˆ‘æ˜¯çœ‹æºä»£ç æ‰ä¼šä½¿ç”¨çš„ï¼Œç½‘ä¸Šèµ„æ–™åŸºæœ¬ä¸º0ï¼Œè€Œä¸”å®˜æ–¹javaä½¿ç”¨æ–‡æ¡£é‡Œä¹Ÿæ²¡ç”¨ï¼Œçš„ç¡®æ˜¯ä¸é‡åˆ°äº†ä¸å°‘å‘ï¼Œå†™å‡ºæ¥æ–¹ä¾¿ä»¥åä½¿ç”¨èƒ½å¿«é€Ÿå›å¿†ã€‚ javaä½¿ç”¨compositeèšåˆ é¦–å…ˆåˆ›å»ºMavené¡¹ç›®,åŠ å…¥ElasticSearchä¾èµ–ï¼š &lt;dependency&gt; &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt; &lt;artifactId&gt;elasticsearch-rest-high-level-client&lt;/artifactId&gt; &lt;version&gt;6.5.4&lt;/version&gt; &lt;/dependency&gt; ç›´æ¥ä¸Šå®ç°ä»£ç : SearchRequest searchRequest = new SearchRequest(&quot;composite_test&quot;); searchRequest.types(&quot;_doc&quot;); SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder(); searchSourceBuilder.size(0); /********************ä»¥ä¸‹ç»„è£…èšåˆçš„ä¸‰ä¸ªå­—æ®µ****************************/ List&lt;CompositeValuesSourceBuilder&lt;?&gt;&gt; sources = new ArrayList&lt;&gt;(); DateHistogramValuesSourceBuilder sendtime = new DateHistogramValuesSourceBuilder(&quot;sendtime&quot;) .field(&quot;sendtime&quot;) .dateHistogramInterval(DateHistogramInterval.days(1)) .format(&quot;yyyy-MM-dd&quot;).order(SortOrder.DESC).missingBucket(false); sources.add(sendtime); TermsValuesSourceBuilder userid = new TermsValuesSourceBuilder(&quot;userid&quot;).field(&quot;userid&quot;).missingBucket(true); sources.add(userid); TermsValuesSourceBuilder dttype = new TermsValuesSourceBuilder(&quot;area&quot;).field(&quot;area&quot;).missingBucket(true); sources.add(dttype); CompositeAggregationBuilder composite =new CompositeAggregationBuilder(&quot;my_buckets&quot;, sources); composite.size(1000); /*********************æ‰§è¡ŒæŸ¥è¯¢******************************/ searchSourceBuilder.aggregation(composite); searchRequest.source(searchSourceBuilder); SearchResponse searchResponse = client.search(searchRequest,RequestOptions.DEFAULT); /********************å–å‡ºæ•°æ®*******************/ Aggregations aggregations = searchResponse.getAggregations(); ParsedComposite parsedComposite = aggregations.get(&quot;my_buckets&quot;); List&lt;ParsedBucket&gt; list = parsedComposite.getBuckets(); Map&lt;String,Object&gt; data = new HashMap&lt;&gt;(); for(ParsedBucket parsedBucket:list){ data.clear(); for (Map.Entry&lt;String, Object&gt; m : parsedBucket.getKey().entrySet()) { data.put(m.getKey(),m.getValue()); } data.put(&quot;count&quot;,parsedBucket.getDocCount()); System.out.println(data); } /*************************************/ ä»£ç ä¸­çš„clientä¸ºRestHighLevelClientï¼Œè¯·è‡ªè¡Œåˆå§‹åŒ–ï¼Œç„¶åæ‰§è¡Œä»£ç ï¼Œæ§åˆ¶å°æ‰“å°å¦‚ä¸‹: {area=35, count=2, sendtime=2019-01-18, userid=400016} {area=33, count=2, sendtime=2019-01-17, userid=400015} {area=33, count=1, sendtime=2019-01-17, userid=400017} æ•°æ®æ­£ç¡®ï¼Œæ–¹æ³•å¯ç”¨ï¼Œå…¶å®è¿™ä¸ªæ–¹æ³•æ˜¯RestHighLevelClientæ›¿æˆ‘ä»¬å°è£…äº†compositeç”ŸæˆDSLã€‚ è¿™é‡Œæ³¨æ„ä¸€ä¸‹missingBucketçš„è®¾ç½®ï¼Œè¿™ä¸ªçš„æ„æ€æ˜¯å¦‚æœè¯¥å­—æ®µæ²¡å€¼ï¼Œä¸ºtrueçš„æ—¶å€™ä¼šè¿”å›nullï¼Œä¸ºfalseä¸è¿”å›æ•´æ¡æ•°æ®ï¼Œæ³¨æ„è¿™é‡Œæ˜¯æ•´æ¡æ•°æ®ï¼Œè€Œä¸æ˜¯å•å•è¿™ä¸ªå­—æ®µè€Œå·²ã€‚ ä½ç‰ˆæœ¬ä½¿ç”¨ESå¤šå­—æ®µèšåˆ ä»¥ä¸Šå°±æ˜¯compositeçš„éªŒè¯å’Œåœ¨javaä¸­çš„ä½¿ç”¨æ–¹æ³•ï¼Œå»ºè®®åœ¨6.5+ç‰ˆæœ¬ä½¿ç”¨ï¼Œä½†è¿™ä¸ªæ—¶å€™å°ä¼™ä¼´å¯èƒ½ä¼šé—®ï¼Œå¦‚æœæˆ‘æ˜¯6.5ä»¥ä¸‹çš„ç‰ˆæœ¬å‘¢ï¼Œè¿™é‡Œæˆ‘ä¹Ÿæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œåªä¸è¿‡æ˜¯æœ‰ç‚¹ç»•ï¼Œç›´æ¥ä¸Šä»£ç ï¼š SearchRequest searchRequest = new SearchRequest(&quot;composite_test&quot;); searchRequest.types(&quot;_doc&quot;); SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder(); searchSourceBuilder.size(0); /********************ä»¥ä¸‹ç»„è£…èšåˆçš„ä¸‰ä¸ªå­—æ®µ****************************/ AggregationBuilder sendtime=AggregationBuilders.dateHistogram(&quot;sendtime&quot;).field(&quot;sendtime&quot;).format(&quot;yyyy-MM-dd&quot;).interval(86400000); AggregationBuilder area=AggregationBuilders.terms(&quot;area&quot;).field(&quot;area&quot;); AggregationBuilder userid=AggregationBuilders.terms(&quot;userid&quot;).field(&quot;userid&quot;); //å®ç°åŠŸèƒ½å…³é”®ç‚¹ area.subAggregation(userid); sendtime.subAggregation(area); /*********************æ‰§è¡ŒæŸ¥è¯¢******************************/ searchSourceBuilder.aggregation(sendtime); searchRequest.source(searchSourceBuilder); SearchResponse searchResponse = client.search(searchRequest,RequestOptions.DEFAULT); /********************å–å‡ºæ•°æ®*******************/ Aggregations aggregations = searchResponse.getAggregations(); //å–å‡ºæ•°æ® aggHandle(aggregations); /*************************************/ è¿è¡Œå“åº”çš„æ•°æ®ä¸º {area=33, count=2, sendtime=2019-01-17, userid=400015}, {area=33, count=1, sendtime=2019-01-17, userid=400017}, {area=35, count=2, sendtime=2019-01-18, userid=400016} æ‰€ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ä¹Ÿèƒ½å¤šå€¼èšåˆæ•°æ®ï¼Œå…¶ä¸­å®ç°çš„å…³é”®ç‚¹åœ¨äº area.subAggregation(userid); sendtime.subAggregation(area); è¿™é‡Œç›¸å½“äºæŠŠæ¯ä¸ªæ¡¶ç»™ä¸²è”èµ·æ¥ï¼Œä¸²è”é¡ºåºæ— è¦æ±‚ï¼Œä½†ç”¨è¿™ç§æ–¹æ³•æœ€åå–æ•°æ®çš„æ—¶å€™æ¯”è¾ƒéº»çƒ¦ï¼Œæˆ‘è¿™é‡Œä¹Ÿåˆ†äº«ä¸€ä¸ªæˆ‘å–æ•°æ®çš„æ–¹æ³• private static List&lt;Map&lt;String,Object&gt;&gt; listmap =new ArrayList&lt;Map&lt;String,Object&gt;&gt;(); private static Map&lt;String,Object&gt; map =new HashMap&lt;String,Object&gt;(16); //ä½¿ç”¨é€’å½’çš„æ–¹å¼å°†èšåˆæ•°æ®ä¸­çš„æ•°æ®ä¸€ä¸€å–å‡ºæ¥ private static void aggHandle(Aggregations agg){ String name =&quot;&quot;; Long longValue = 0L; for(Aggregation data:agg){ name = data.getName(); Object obj = agg.get(name); if(obj instanceof Terms){ Terms terms = (Terms) obj; name = terms.getName(); if(terms.getBuckets().size()==0){ listmap.add(clonMap(map)); } for (Terms.Bucket entry : terms.getBuckets()) { map.put(name, entry.getKey()); longValue = entry.getDocCount(); map.put(count, longValue); List&lt;Aggregation&gt; list = entry.getAggregations().asList(); if(list==null||list.isEmpty()){ listmap.add(clonMap(map)); }else{ aggHandle(entry.getAggregations()); } } }else if(obj instanceof ParsedDateHistogram){ ParsedDateHistogram terms = (ParsedDateHistogram) obj; List&lt;? extends Bucket&gt; buckets = terms.getBuckets(); name = terms.getName(); if(buckets.size()==0){ listmap.add(clonMap(map)); } for(Bucket entry:buckets){ map.put(name,entry.getKeyAsString()); longValue = entry.getDocCount(); map.put(count, longValue); List&lt;Aggregation&gt; list = entry.getAggregations().asList(); if(list==null||list.isEmpty()){ listmap.add(clonMap(map)); //map.clear(); }else{ aggHandle(entry.getAggregations()); } } }else if(obj instanceof Max){ Max max =(Max) obj; name = max.getName(); Double value = max.getValue(); longValue =value.longValue(); map.put(name, longValue); listmap.add(clonMap(map)); }else if(obj instanceof Min){ Min min =(Min) obj; Double value = min.getValue(); longValue =value.longValue(); map.put(min.getName(), longValue); listmap.add(clonMap(map)); }else if(obj instanceof Avg){ Avg avg = (Avg) obj; Double value = avg.getValue(); longValue =value.longValue(); map.put(avg.getName(), longValue); listmap.add(clonMap(map)); }else if(obj instanceof Sum){ Sum sum = (Sum) obj; Double value = sum.getValue(); longValue =value.longValue(); map.put(sum.getName(), longValue); listmap.add(clonMap(map)); }else if(obj instanceof ValueCount){ ValueCount count = (ValueCount) obj; longValue =count.getValue(); map.put(count.getName(), longValue); listmap.add(clonMap(map)); }else{ System.out.println(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;+obj); } } } /** * å…‹éš†mapå¯¹è±¡åˆ°å¦å¤–ä¸€ä¸ªmapå¯¹è±¡é‡Œé¢å» * @param map * @return */ private static Map&lt;String,Object&gt; clonMap(Map&lt;String,Object&gt; mapTo){ Map&lt;String,Object&gt; map = new HashMap&lt;String,Object&gt;(16); for (Map.Entry&lt;String,Object&gt; entry : mapTo.entrySet()) { String key = entry.getKey(); Object value = entry.getValue(); map.put(key, value); } return map; } https://blog.csdn.net/qq_18895659/article/details/86540548 ","link":"https://kychill1986.github.io/post/elasticsearch-zhong-composite-ju-he-de-shi-yong-zhuan/"},{"title":"Java 8 BiFunction å’Œ BiConsumerä½¿ç”¨","content":"BiFunction è¿™é‡Œæé†’ä¸€ç‚¹ï¼Œå¯ä»¥çœ‹å‡ºè¯¥æ¥å£ä¸­æœ‰æ–¹æ³•çš„å®ç°ï¼Œä¸å•å•åªæœ‰æŠ½è±¡æ–¹æ³•ï¼Œåœ¨java8ä¸­ï¼Œæœ‰ä¸€ä¸ªæ–°çš„æ”¹è¿›å°±æ˜¯åœ¨ç°æœ‰çš„æ¥å£ä¸­å¢åŠ äº†ä¸€äº›é»˜è®¤çš„æ–¹æ³•å®ç°ï¼Œä½¿ç”¨defaultå…³é”®å­—æ¥ä¿®é¥°ã€‚è¿™ç§åšæ³•ä¸ä¼šå½±å“ä»¥å‰ä»£ç å¯¹æ¥å£çš„å®ç°ï¼Œä¹Ÿå¯¹åŸæœ‰çš„æ¥å£è¿›è¡Œäº†æ‰©å±•ã€‚ ä¼ é€’è¡Œä¸ºç»™æ–¹æ³•ï¼Œè€Œä¸æ˜¯ä¼ é€’å€¼ã€‚ /** * BiFunctionæ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œå®ƒæ¥å£ä¸¤ä¸ªå‚æ•°å¹¶äº§ç”Ÿä¸€ä¸ªç»“æœå€¼è¿”å›ã€‚ * å®ƒé‡Œé¢æœ‰ä¸€ä¸ªapply(Object,Object)æ–¹æ³•ã€‚ * @param &lt;T&gt; å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ç±»å‹ * @param &lt;U&gt; å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ç±»å‹ * @param &lt;R&gt; å‡½æ•°çš„ç»“æœç±»å‹ * @since 1.8 */ @FunctionalInterface public interface BiFunction&lt;T, U, R&gt; { /** * å°†applyå‡½æ•°åº”ç”¨åˆ°ç»™å®šçš„å‚æ•°ä¸Šé¢ * * @param t å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•° * @param u å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•° * @return R å‡½æ•°çš„ç»“æœ */ R apply(T t, U u); /** * è¿”å›ä¸€ä¸ªç»„åˆçš„å‡½æ•°ï¼Œç¬¬ä¸€æ¬¡æ˜¯å°†è¯¥å‡½æ•°åº”ç”¨åˆ°å®ƒçš„è¾“å…¥ï¼Œæ¥ç€æ˜¯å°†è¯¥å‡½æ•°çš„afteråº”ç”¨åˆ° * ä¹‹å‰çš„ç»“æœä¸Šã€‚å¦‚æœåœ¨ä»»ä¸€å‡½æ•°è¯„æµ‹æœŸé—´æŠ›å‡ºå¼‚å¸¸ï¼Œå®ƒéƒ½ä¼šè¢«ä¼ é€’ç»™ç»„åˆå‡½æ•°çš„è°ƒç”¨è€…ã€‚ * @param &lt;V&gt; ç»„åˆå‡½æ•°å’Œafterå‡½æ•°çš„è¾“å‡ºç±»å‹ * @param after è¯¥å‡½æ•°åº”ç”¨å°†è¢«åœ¨å½“å‰å‡½æ•°applyåè¢«apply * @return è¿”å›ä¸€ä¸ªç»„åˆå‡½æ•°ï¼Œç¬¬ä¸€æ¬¡åº”ç”¨è¯¥å‡½æ•°ï¼Œæ¥ç€åº”ç”¨afterå‡½æ•° * @throws å½“afterä¸ºnullçš„æ—¶å€™ï¼Œä¼šæŠ›å‡ºNullPointerExceptionå¼‚å¸¸ã€‚ */ default &lt;V&gt; BiFunction&lt;T, U, V&gt; andThen(Function&lt;? super R, ? extends V&gt; after) { Objects.requireNonNull(after); return (T t, U u) -&gt; after.apply(apply(t, u)); } } import java.util.function.BiFunction; import java.util.function.Function; public class BiFunctionTest { public static void main(String[] args){ BiFunctionTest test = new BiFunctionTest(); //å®ç°å››åˆ™è¿ç®— System.out.println(test.compute(4,2,(value1,value2)-&gt;value1+value2)); System.out.println(test.compute(4,2,(v1,v2)-&gt;v1-v2)); System.out.println(test.compute(1,2,(v1,v2)-&gt;v1*v2)); System.out.println(test.compute(3,2,(v1,v2)-&gt;v1/v2)); System.out.println(test.calcute(3,4,(v1,v2)-&gt;v1+v2,v-&gt;v * v)); } public int compute(int num1, int num2, BiFunction&lt;Integer,Integer,Integer&gt; biFunction){ return biFunction.apply(num1,num2); } public int calcute(int num1, int num2, BiFunction&lt;Integer,Integer,Integer&gt; biFunction, Function&lt;Integer,Integer&gt; function){ //è°ƒç”¨addThené¦–å…ˆå¯¹æ¥æ”¶çš„ä¸¤ä¸ªå‚æ•°è¿›è¡Œbifunctionçš„applyï¼Œç„¶ååœ¨è¿›è¡Œfunctionçš„apply return biFunction.andThen(function).apply(num1,num2); } } è¾“å‡ºç»“æœï¼š 6 2 2 1 49 BiConsumer BiConsumer&lt;T,U&gt;æ¥å£æ˜¯java8 Functionå‡½æ•°é‡Œé¢çš„æ¥å£ï¼Œå®ƒæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œ BiConsumerç”¨æ³•å¾ˆç®€å•ã€‚ //æ¥æ”¶å‚æ•° void accept(T t, U u) //é»˜è®¤æ–¹æ³•ï¼ŒåŸºæœ¬æ²¡ä»€ä¹ˆç”¨ default BiConsumer&lt;T,U&gt; andThen(BiConsumer&lt;? super T,? super U&gt; after) BiConsumerç”¨æ³•ç¤ºä¾‹(java8)ç¤ºä¾‹å¦‚ä¸‹ï¼ŒandThen(biConsumer)æ–¹æ³•æ²¡æœ‰ä»€ä¹ˆæ•ˆæœ(å¯ä¸ç”¨)ï¼Œä¸»è¦æ˜¯å­¦ä¼šä½¿ç”¨accept(T t, U u)æ–¹æ³•ï¼Œå¦‚ä¸‹ã€‚ import java.util.function.BiConsumer; public class TestDemo { public static void main(String[] args) { BiConsumer&lt;String, String&gt; biConsumer = (x, y) -&gt; { System.out.println(x+&quot;===&quot;+y); }; biConsumer.andThen(biConsumer).accept(&quot;tpyyes.com &quot;, &quot; java8&quot;); } } è¾“å‡ºxä¸yå‚æ•°çš„å€¼ï¼Œå¦‚ä¸‹ã€‚ tpyyes.com === java8 tpyyes.com === java8 https://www.tpyyes.com/a/java/283.html http://www.manongjc.com/article/50415.html ","link":"https://kychill1986.github.io/post/java-8-bifunction-he-biconsumer-shi-yong/"},{"title":"Elasticsearch èšåˆåˆ†é¡µæ’åº","content":"åˆ†é¡µ è¯·æ±‚JSONï¼š GET oms_sku_shortage_order_index/_search { &quot;query&quot;: { &quot;bool&quot;: { &quot;must&quot;: [ { &quot;match&quot;: { &quot;oos&quot;: true } } ] } }, &quot;aggs&quot;: { &quot;by_wog&quot;: { &quot;terms&quot;: { &quot;field&quot;: &quot;wog.keyword&quot;, &quot;size&quot;: 100000000 }, &quot;aggs&quot;: { &quot;sum_num&quot;: { &quot;sum&quot;: { &quot;field&quot;: &quot;num&quot; } }, &quot;bucket_field&quot;: { &quot;bucket_sort&quot;: { &quot;sort&quot;: [ { &quot;sum_num&quot;: { &quot;order&quot;: &quot;desc&quot; } } ], &quot;from&quot;: 0, &quot;size&quot;: 10 } } } } } } Javaä»£ç ï¼š SearchSourceBuilder sourceBuilder = new SearchSourceBuilder(); BoolQueryBuilder boolBuilder = QueryBuilders.boolQuery(); boolBuilder.must(QueryBuilders.matchQuery(&quot;oos&quot;, true)); if (CollectionUtils.isNotEmpty(pageQueryShortageBO.getWarehouseCodeList())) { boolBuilder.must(QueryBuilders.termsQuery(&quot;w.keyword&quot;, w)); } if (CollectionUtils.isNotEmpty(pageQueryShortageBO.getOwnerCodeList())) { boolBuilder.must(QueryBuilders.termsQuery(&quot;o.keyword&quot;, o)); } if (CollectionUtils.isNotEmpty(pageQueryShortageBO.getGoodsCodeList())) { boolBuilder.must(QueryBuilders.termsQuery(&quot;g.keyword&quot;, g)); } sourceBuilder.query(boolBuilder); TermsAggregationBuilder aggregation = AggregationBuilders.terms(&quot;by_wog&quot;).field(&quot;wog.keyword&quot;).size(100000); aggregation.subAggregation(AggregationBuilders.sum(&quot;sum_num&quot;).field(&quot;num&quot;)); List&lt;FieldSortBuilder&gt; fieldSorts = new ArrayList&lt;&gt;(); fieldSorts.add(new FieldSortBuilder(&quot;sum_num&quot;)); aggregation.subAggregation(new BucketSortPipelineAggregationBuilder(&quot;bucket_field&quot;, fieldSorts).from((pageQueryShortageBO.getPageNum() - 1) * pageQueryShortageBO.getPageSize()).size(pageQueryShortageBO.getPageSize())); sourceBuilder.aggregation(aggregation); SearchRequest searchRequest = new SearchRequest(&quot;shortage_index&quot;); searchRequest.types(ESConstants.TYPE); searchRequest.source(sourceBuilder); SearchResponse response = null; try { response = client.search(searchRequest, RequestOptions.DEFAULT); } catch (IOException e) { log.error(&quot;queryShortageFromES error: {}&quot;, e.getMessage(), e); } if (response != null) { Aggregations aggregations = response.getAggregations(); Terms byCompanyAggregation = aggregations.get(&quot;by_wog&quot;); List&lt;? extends Terms.Bucket&gt; buckets = byCompanyAggregation.getBuckets(); for (Terms.Bucket bucket : buckets) { Sum sum = bucket.getAggregations().get(&quot;sum_num&quot;); String wog = bucket.getKeyAsString(); String[] wogArray = wog.split(ESConstants.WOG_SPLIT_FLAG); } } è¯´æ˜ï¼šå› ä¸ºbucket_sortæ˜¯å¯¹èšåˆä¹‹åçš„æ¡¶è¿›è¡Œåˆ†é¡µæ’åº,æ‰€ä»¥termsé‡Œé¢çš„sizeè®¾ç½®è¦å¤§äºbucket_sorté‡Œé¢åˆ†é¡µå¤§å°ï¼Œä¸ç„¶ä¼šå–ä¸åˆ°æ•°æ® è®¡ç®—count è¯·æ±‚JSONï¼š GET oms_sku_shortage_order_index/_search { &quot;query&quot;: { &quot;bool&quot;: { &quot;must&quot;: [ {&quot;match&quot;: { &quot;oos&quot;: true }} ] } }, &quot;aggs&quot;: { &quot;by_wog&quot;: { &quot;cardinality&quot;: { &quot;field&quot;: &quot;wog.keyword&quot; } } } } Javaä»£ç ï¼š SearchSourceBuilder sourceBuilder = new SearchSourceBuilder(); BoolQueryBuilder boolBuilder = QueryBuilders.boolQuery(); boolBuilder.must(QueryBuilders.matchQuery(&quot;oos&quot;, true)); if (CollectionUtils.isNotEmpty(pageQueryShortageBO.getWarehouseCodeList())) { boolBuilder.must(QueryBuilders.termsQuery(&quot;w.keyword&quot;, w)); } if (CollectionUtils.isNotEmpty(pageQueryShortageBO.getOwnerCodeList())) { boolBuilder.must(QueryBuilders.termsQuery(&quot;o.keyword&quot;, o)); } if (CollectionUtils.isNotEmpty(pageQueryShortageBO.getGoodsCodeList())) { boolBuilder.must(QueryBuilders.termsQuery(&quot;g.keyword&quot;, g)); } sourceBuilder.query(boolBuilder); CardinalityAggregationBuilder aggregation = AggregationBuilders.cardinality(&quot;by_wog&quot;).field(&quot;wog.keyword&quot;); sourceBuilder.aggregation(aggregation); SearchRequest searchRequest = new SearchRequest(&quot;shortage_index&quot;); searchRequest.types(ESConstants.TYPE); searchRequest.source(sourceBuilder); SearchResponse response = null; try { response = client.search(searchRequest, RequestOptions.DEFAULT); } catch (IOException e) { log.error(&quot;getShortageTotalPage error: {}&quot;, e.getMessage(), e); } if (response != null) { Aggregations aggregations = response.getAggregations(); Cardinality byCompanyAggregation = aggregations.get(&quot;by_wog&quot;); return Integer.parseInt(String.valueOf(byCompanyAggregation.getValue())); } ","link":"https://kychill1986.github.io/post/elasticsearch-ju-he-fen-ye-pai-xu/"},{"title":"è™šæ‹Ÿæœºå†…çš„ElasticSearch 7.6.0ï¼Œå¯ä»¥åœ¨å®¿ä¸»æœºç”¨IPè¿›è¡Œè®¿é—®(CentOS)","content":"ğŸ–¥ ElasticSearch å¯¹å¤–å¯è®¿é—®é…ç½® 1.å…³é—­é˜²ç«å¢™ï¼Œæˆ–è€…åŠ ä¾‹å¤– a. æŸ¥çœ‹firewallæœåŠ¡çŠ¶æ€ systemctl status firewalld b. æŸ¥çœ‹firewallçš„çŠ¶æ€ firewall-cmd --state d. å¼€å¯ã€é‡å¯ã€å…³é—­ã€firewalld.serviceæœåŠ¡ # å¼€å¯ service firewalld start # é‡å¯ service firewalld restart # å…³é—­ service firewalld stop e. æŸ¥çœ‹é˜²ç«å¢™è§„åˆ™ firewall-cmd --list-all f. æŸ¥è¯¢ã€å¼€æ”¾ã€å…³é—­ç«¯å£ # æŸ¥è¯¢ç«¯å£æ˜¯å¦å¼€æ”¾ firewall-cmd --query-port=8080/tcp # å¼€æ”¾80ç«¯å£ firewall-cmd --permanent --add-port=80/tcp # ç§»é™¤ç«¯å£ firewall-cmd --permanent --remove-port=8080/tcp #é‡å¯é˜²ç«å¢™(ä¿®æ”¹é…ç½®åè¦é‡å¯é˜²ç«å¢™) firewall-cmd --reload # å‚æ•°è§£é‡Š 1ã€firwall-cmdï¼šæ˜¯Linuxæä¾›çš„æ“ä½œfirewallçš„ä¸€ä¸ªå·¥å…·ï¼› 2ã€--permanentï¼šè¡¨ç¤ºè®¾ç½®ä¸ºæŒä¹…ï¼› 3ã€--add-portï¼šæ ‡è¯†æ·»åŠ çš„ç«¯å£ï¼› 2. ä¿®æ”¹elasticsearch.yml network.host: 192.168.33.134 #å¯ä»¥ç›´æ¥å†™éƒ¨ç½²ESçš„IP http.port: 9200 node.name: node-1 bootstrap.memory_lock: false bootstrap.system_call_filter: false cluster.initial_master_nodes: [&quot;node-1&quot;] #è¿™ä¸ªâ€œnode-1â€å…¶å®å°±æ˜¯ä¸Šé¢çš„â€œnode.nameâ€é…ç½®é¡¹ 3. ä¿®æ”¹linuxç³»ç»Ÿé…ç½® ä¿®æ”¹sysctl.conf sudo vim /etc/sysctl.conf vm.max_map_count=262144 æ£€æŸ¥é…ç½®æ˜¯å¦ç”Ÿæ•ˆ sysctl -a | grep â€œvm.max_map_countâ€ æ˜¾ç¤ºvm.max_map_count = 262144 ç¼–è¾‘/etc/security/limits.conf * soft nofile 65536 * hard nofile 65536 * soft nproc 4096 * hard nproc 4096 #ä»¥ä¸Šçš„é…ç½®æ˜¯é’ˆå¯¹rootç”¨æˆ·çš„ chill soft nofile 65536 chill hard nofile 65536 #ä»¥ä¸Šçš„é…ç½®æ˜¯é’ˆå¯¹chillç”¨æˆ·çš„ è¿™æ ·åœ¨å®¿ä¸»æœºè¾“å…¥http://192.168.89.128:9200/ï¼Œå°±å¯ä»¥çœ‹åˆ°esæ­£å¸¸å¯åŠ¨äº† å¯åŠ¨æ—¶æŸ¥çœ‹elasticsearch.logæ—¥å¿—ï¼Œå¦‚æœä¼šçœ‹åˆ°å¦‚ä¸‹çš„é”™è¯¯æç¤ºï¼Œé‚£ä¹ˆæŒ‰ç…§ä¸Šé¢çš„elasticsearch.ymlï¼Œå°±å¯ä»¥è§£å†³ï¼Œå¦‚æœè§£å†³ä¸äº†ï¼Œå¯ä»¥é’ˆå¯¹é—®é¢˜ç›´æ¥baidu [3] bootstrap checks failed [1]: max file descriptors [4096] for elasticsearch process is too low, increase to at least [65535] [2]: max number of threads [3790] for user [chill] is too low, increase to at least [4096] [3]: the default discovery settings are unsuitable for production use; at least one of [discovery.seed_hosts, discovery.seed_providers, clus ter.initial_master_nodes] must be configured ","link":"https://kychill1986.github.io/post/xu-ni-ji-nei-de-elasticsearch-760ke-yi-zai-su-zhu-ji-yong-ip-jin-xing-fang-wen-centos/"},{"title":"Mac ç³»ç»Ÿå®‰è£…ElasticSearch","content":"ğŸ–¥ åŒ…å«å•æœºå®‰è£…ï¼Œä»¥åŠé›†ç¾¤é…ç½®ä»‹ç»... å•æœºå®‰è£… ä¸‹è½½elasticSearch http://elastic.co è§£å‹elasticSearch...tar.gz å¯åŠ¨elasticSearch ./bin/elasticsearch -d #åå°è¿è¡Œ å®‰è£…elasticSearch-headæ’ä»¶ ä¸‹è½½elasticSearch-headï¼Œè®¿é—®gitHubï¼Œæœç´¢elasticSearch-headï¼Œåœ¨æœç´¢ç»“æœé‡Œç‚¹å‡»â€œmobz/elasticsearch-headâ€ è§£å‹elasticSearch-head cd '/Users/xxx/Documents/Tools/ElasticSearch/elasticsearch-head-master/' å®‰è£…æœ€æ–°ç‰ˆnode brew install node å®‰è£…grunt npm install -g grunt-cli åœ¨elasticsearch-head-masterç›®å½•æ‰§è¡Œ npm install å¦‚æœå®‰è£…è¿‡ç¨‹ä¸­å‡ºç°ï¼š 1. Failed at the phantomjs-prebuilt@2.1.15 install script â€˜node install.jsâ€™. è§£å†³æ–¹æ³•ï¼š npm install phantomjs-prebuilt@2.1.15 --ignore-scripts 2. Local Npm module &quot;grunt-contrib-jasmine&quot; not found. Is it installed è§£å†³åŠæ³•ï¼š npm install grunt-contrib-jasmine --registry=https://registry.npm.taobao.org #ä½¿ç”¨å›½å†…é•œåƒ å¯åŠ¨elasticSearch-head npm run start æµ‹è¯•ï¼šhttp://serverip:9100/ é…ç½®elasticsearch ä½¿elasticSearch-headèƒ½æ­£å¸¸è®¿é—®ï¼ˆè¿™ä¸¤ä¸ªæ˜¯ç‹¬ç«‹çš„è¿›ç¨‹ï¼Œæœ‰è·¨åŸŸé—®é¢˜ï¼‰ï¼Œä¿®æ”¹elasticsearchï¼Œconfig/elasticsearch.ymlæ–‡ä»¶ï¼ŒåŠ å…¥å¦‚ä¸‹ä»£ç ï¼š http.cors.enabled: true http.cors.allow-origin: &quot;*&quot; é‡æ–°å¯åŠ¨elasticsearchï¼Œè®¿é—®elasticSearch-headï¼Œhttp://serverip:9100/ ElasticSearché›†ç¾¤é…ç½® ä¿®æ”¹config/elasticsearch.ymlæ–‡ä»¶ master: http.cors.enabled: true http.cors.allow-origin: &quot;*&quot; cluster.name: chillcluster node.name: chillmaster node.master: true slave1: cluster.name: chillcluster node.name: slave1 network.host: 127.0.0.1 http.port: 9201 discovery.zen.ping.unicast.hosts: [&quot;127.0.0.1&quot;] #æ‰¾åˆ°masterï¼Œå¦‚æœä¸åšè¿™ä¸ªé…ç½®é‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹å°±æ˜¯æ¸¸ç¦»äºé›†ç¾¤ä¹‹å¤–çš„ slave2: cluster.name: chillcluster node.name: slave2 network.host: 127.0.0.1 http.port: 9202 discovery.zen.ping.unicast.hosts: [&quot;127.0.0.1&quot;] #æ‰¾åˆ°masterï¼Œå¦‚æœä¸åšè¿™ä¸ªé…ç½®é‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹å°±æ˜¯æ¸¸ç¦»äºé›†ç¾¤ä¹‹å¤–çš„ #å½©è›‹ğŸ† å®˜æ–¹ä¸‹è½½ä¸‹æ¥çš„elasticsearchå®‰è£…åŒ…ï¼Œç›´æ¥è§£å‹ï¼Œè¿è¡Œä»¥å‰å‘½ä»¤ï¼Œä¹Ÿå¯ä»¥å®ç°åŒæ ·çš„é›†ç¾¤æ•ˆæœ å¤æ‚çš„ï¼š ./elasticsearch -E node.name=chillmaster -E cluster.name=chillcluster -E node.master=true -E http.cors.enabled=true -E http.cors.allow-origin=&quot;*&quot; -E path.data=node1_data -d ./elasticsearch -E node.name=slave1 -E cluster.name=chillcluster -E network.host=127.0.0.1 -E http.port=9201 -E discovery.zen.ping.unicast.hosts=&quot;127.0.0.1&quot; -E path.data=node2_data -d ./elasticsearch -E node.name=slave2 -E cluster.name=chillcluster -E network.host=127.0.0.1 -E http.port=9202 -E discovery.zen.ping.unicast.hosts=&quot;127.0.0.1&quot; -E path.data=node3_data -d ç®€å•çš„ï¼š ./elasticsearch -E node.name=node1 -E cluster.name=chillcluster -E path.data=node1_data -d ./elasticsearch -E node.name=node2 -E cluster.name=chillcluster -E path.data=node2_data -d ./elasticsearch -E node.name=node3 -E cluster.name=chillcluster -E path.data=node3_data -d æœ€åç”¨http://127.0.0.1:9200/_cat/nodesï¼Œæ£€æŸ¥ä¸‹æ˜¯å¦æ­£å¸¸ Reference https://blog.csdn.net/fenglailea/article/details/52934263 http://www.bubuko.com/infodetail-2108888.html ","link":"https://kychill1986.github.io/post/mac-xi-tong-an-zhuang-elasticsearch/"}]}